services:
  # ==========================================================================
  # Ollama - Local AI
  # ==========================================================================
  ollama:
    image: ollama/ollama:latest
    container_name: nora_ollama
    restart: unless-stopped
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    networks:
      - nora_network

  # ==========================================================================
  # Gateway - Web UI & API (with Authentication & File Management)
  # ==========================================================================
  gateway:
    build:
      context: ./gateway
      dockerfile: Dockerfile
    container_name: nora_gateway
    restart: unless-stopped
    ports:
      - "8765:8765"
    environment:
      GATEWAY_HOST: "0.0.0.0"
      GATEWAY_PORT: "8765"
      AI_PROVIDER: "${AI_PROVIDER:-ollama}"
      AI_SERVER_URL: "http://ollama:11434"
      AI_MODEL: "${AI_MODEL:-llama2}"
      GEMINI_API_KEY: "${GEMINI_API_KEY:-}"
      # Security Configuration
      SECRET_KEY: "${SECRET_KEY:-change_this_secret_key_in_production}"
      ADMIN_USERNAME: "${ADMIN_USERNAME:-admin}"
      ADMIN_PASSWORD: "${ADMIN_PASSWORD:-admin123}"
    volumes:
      - ./company_info:/app/company_info:rw
      - ./uploads:/app/uploads:rw
    depends_on:
      - ollama
    networks:
      - nora_network

  # ==========================================================================
  # Cloudflare Tunnel (Optional - Secure Public Access)
  # ==========================================================================
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: nora_cloudflared
    restart: unless-stopped
    command: tunnel run --token ${CLOUDFLARE_TUNNEL_TOKEN}
    environment:
      # Metrics and logging
      TUNNEL_METRICS: "0.0.0.0:2000"
      TUNNEL_LOGLEVEL: "info"
    depends_on:
      - gateway
    profiles:
      - tunnel
    networks:
      - nora_network

volumes:
  ollama_data:

networks:
  nora_network:
    driver: bridge
